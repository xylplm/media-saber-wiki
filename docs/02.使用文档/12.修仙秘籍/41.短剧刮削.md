---
title: 短剧刮削
action: false
tags:
  - 修仙秘籍
categories:
editor: markdown
permalink: /docs/cultivation_secrets/short_play_monitor/
date: 2025-11-19 00:00:00
---

# 🎭 短剧刮削

**短剧刮削** 插件用于监控指定的「短剧」视频目录，一旦有新剧或新剧集加入，自动进行刮削和整理（如补充元数据、重命名、移动到规范目录结构等）。

## ⚙️ 功能特点

- 监控短剧视频目录变化
- 自动刮削短剧名称、集数等信息
- 按规则整理到规范化的目录结构
- 支持定时扫描或近实时监控（视实现为准）
- 支持消息推送汇报处理结果

## 🚀 配置指南

在插件配置页面中可以看到所有核心字段，下面从「如何填写」的角度进行说明：

### 📂 监控目录与重命名规则（monitorConfs）

1. **监控配置 (monitorConfs)**  
   每行一条规则，格式为：

   `监控方式#监控目录#目的目录#重命名策略`

   - 监控方式：
     - `compatibility`：兼容模式，使用轮询方式监听文件变动；
     - 其他值：使用原生文件事件监听（推荐）。
   - 监控目录：必填，用于监听短剧文件的下载目录，支持递归子目录；
   - 目的目录：必填，整理后的短剧库根目录；
   - 重命名策略：
     - `true`：按规则重命名文件；
     - `smart`：开启“智能重命名 + 站点封面刮削”（推荐）；
     - 其他值：不改原文件名，仅调整目录结构。

  > ⚠️ **限制**：如果目的目录是监控目录的子目录，该规则会被直接忽略，以避免递归触发死循环。

2. **排除关键词 (excludeKeywords)**  
   - 多行文本，每行一个关键词；
   - 文件路径中包含任一关键词的媒体会被跳过，不参与刮削与转移；
   - 常用于排除临时目录、缓存目录或某些不想被处理的分类。

3. **转移方式 (transferType)**  
   - 控制文件从监控目录转到目的目录时的方式：
     - `link`（默认）：硬链接；
     - `softlink`：软链接；
     - `copy`：复制；
     - `move`：移动（原文件会被移走）。

4. **截帧封面 (enableFFmpeg)**  
   - 布尔开关，开启后会尝试使用本机 `ffmpeg` / `ffprobe` 从视频中截取一帧作为 `poster.jpg`；
   - 插件启动时会检测 FFmpeg 是否可用，如不可用会在日志中提示（Alpine 环境可使用 `apk add ffmpeg` 安装）。

### 🎯 刮削站点与延迟通知

5. **刮削站点代码 (scrapeSiteCode)**  
   - 用于从指定 PT 站点获取短剧封面；
   - 默认值为 `agsvpt`，目前代码中对 `agsvpt`、`ilolicon` 做了特殊适配；
   - 插件会根据剧名调用站点搜索页，解析第一个资源详情页中的 `#kdescr img` 作为封面图。

6. **入库消息延迟 (interval)**  
   - 单位：秒；
   - 用于“合并多集入库通知”：
     - 插件会把同一部剧在一段时间内入库的多个文件进行聚合；
     - 当某部剧 **最后一次更新距离当前时间超过 interval 秒** 时，才会发送一条汇总通知。

7. **消息推送 (notify)**  
   - 开启后，在该短剧目录中完成一段时间的入库处理后会发送一条汇总消息；
   - 若关闭，则仍会在日志中记录处理过程，但不会推送通知。

### 🔧 工具栏操作

- **运行一次 (run)**：立即触发一次“全量扫描 + 刮削”，会对当前配置的所有监控目录做一遍遍历处理，用于初次整理或手动修正。 

## 📖 使用说明

### 监控与触发方式

1. **实时监控**  
   - 插件启动后，会为每个有效的 `monitorConfs` 规则创建一个目录监听器；
   - 只对「创建 / 写入 / 重命名 / 移动」事件生效；
   - 仅处理视频文件（内部通过 `IsMediaFile` 判断），其它类型文件会被忽略；
   - 路径中包含 `excludeKeywords` 的文件会被过滤掉。

2. **全量扫描（手动）**  
   - 点击「运行一次 (run)」时，会对所有监控目录做一次 `walk`：
     - 逐个发现符合条件的媒体文件；
     - 依次走一遍“识别 → 刮削 → 转移 → 封面生成 → 聚合通知”的流程；
     - 适合用于：初始化老目录、重新整理目录结构。

### 刮削与整理流程

1. **元数据识别**  
   - 使用内置 `metadata` 模块，根据文件名和路径解析：剧名、季数、集数等信息；
   - 若无法解析出中英文标题（`CnName/EnName` 都为空），该文件会被标记为“无法识别”并跳过。

2. **基于 TMDB 的智能整理**  
   - 若能获取 TMDB 详情（`TmdbDetails`）：
     - 使用 TMDB 标题作为剧集主目录名；
     - 根据解析到的季、集信息（未解析到则默认 S01E01）生成标准路径：
       - `{目的目录}/{剧名}/Season 01/{剧名} - S01E01.ext`；
     - 自动生成 `tvshow.nfo`，包含标题、简介、年份、首播日期等基础信息；
     - 调用封面生成逻辑，为该剧生成 `poster.jpg`（见下文）。

3. **简单整理模式**  
   - 若 TMDB 信息缺失，则退化到“简单转移”：
     - 保留相对路径结构，将文件从监控目录映射到目的目录；
     - 如开启重命名：
       - 优先从文件名中提取 `SxxEyy` 格式；
       - 失败时使用识别出的剧名 + 原扩展名作为文件名；
     - 同样会尝试生成 `tvshow.nfo` 与封面。

4. **文件转移方式**  
   - 实际的“转移”通过系统内的文件任务实现：
     - `link`：硬链接到目标目录；
     - `softlink`：软链接；
     - `copy`：复制一份；
     - `move`：移动（剪切）。

### 封面生成逻辑

插件在生成 `poster.jpg` 时会按以下优先级尝试：

1. **PT 站点封面抓取（当重命名策略为 smart 且配置了 scrapeSiteCode）**  
   - 从配置的 PT 站点（如 `agsvpt`/`ilolicon`）按剧名搜索；
   - 解析搜索结果的第一个种子详情页中 `#kdescr img` 的图片作为封面；
   - 自动补全为完整 `https://domain/...` URL 并下载保存到 `poster.jpg`。

2. **TMDB 剧照**  
   - 若 TMDB 返回了剧集剧照地址（`StillPath`），则尝试从 TMDB 原图地址下载；

3. **视频截帧（需开启 enableFFmpeg 且环境中有 FFmpeg/ffprobe）**  
   - 优先获取视频总时长，取 10% 位置（最大不超过 30 秒）作为截图时间点；
   - 调用 `ffmpeg -ss {秒} -i 输入 -vframes 1 -q:v 2 poster.jpg` 生成缩略图；

4. **目录现有图片兜底**  
   - 若前面步骤都失败，会扫描目录下现有的 `*.jpg` 文件；
   - 选第一张作为 `poster.jpg`，并可选删除多余图片，保持目录干净。

## ⚠️ 注意事项

- 仅对视频文件生效，字幕、图片、种子等附件不会触发整理；
- 短剧命名风格极其多样，遇到无法识别的情况可以先调整文件名再重新运行；
- 首次全量整理大量文件时可能耗时较久，建议在系统负载较低时执行；
- 若使用 `move` 模式，原始文件会真正移动到目的目录，请事先确认目标路径与权限；
- 启用 FFmpeg 截图时，请确保容器/主机中已正确安装 ffmpeg/ffprobe；
- 插件标记为 Limited 时，请遵守系统内关于访问频率和使用范围的限制说明。

## 🔗 相关链接

- [修仙秘籍主页](/docs/cultivation_secrets/main/)
- [Cron 表达式说明](/docs/other/cron_rule/)

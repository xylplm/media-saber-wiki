---
title: Compose全家桶搭配 env 安装
article: false
date: 2025-11-20T12:20:20.888Z
tags:
categories: 
  - 新手指引
  - 如何安装
editor: markdown
dateCreated: 2025-11-20T12:20:20.888Z
permalink: /guide/install/compose_all_env
---

> 此方式适合飞牛、绿联、极空间、群晖等一切支持 docker compose 的设备
> 此教程适合有一定 linux 命令行基础和 docker 基础的用户


## 项目目录
```txt
├── msgo
│   ├── common
│   ├── redis
│   ├── pgsql
│   ├── ms
│   ├── qb
│   ├── tr
│   ├── emby
│   ├── docker-compose.yml
│   └── .env
```


## env 配置

这里注意下
1. 使用 `DOCKER_PATH`、`MEDIA_PATH` 可以简化 docker yaml 的路径，同时也可以避免暴露路径中包含的手机号（如极空间）
2. 如果有多个 `MEDIA_PATH`, 那么可以用 `MEDIA_PATH_1`, `MEDIA_PATH_2` 等变量来配置
3. LOCAL_IP 是 NAS 所在局域网的 IP，用于 Emby 配置， PROXY_IP 是代理服务器的 IP
4. PUID 和 PGID 是用户权限，默认是 1000 和 1001，根据自己的情况修改
5. PG、Reids，使用15432、16379端口，避免与主机冲突（很多 nas 都有自己的PostGres和Redis）
如在命令行中执行得到
```bash
[allen@fnNAS] /vol1/1000/docker  
❯ id
uid=1000(allen) gid=1001(Users) groups=1001(Users),994(docker),1000(Administrators)
```
当然，直接使用 `PUID=0`, `PGID=0` 也是可以的

### `.env` 文件配置

```yaml
# 路径
DOCKER_PATH=/vol1/1000/docker
MEDIA_PATH=/vol2/1000/media

# 局域网IP和端口
LOCAL_IP=192.168.3.20
PROXY_IP=192.168.3.15
PROXY_PORT=7890

# 用户权限
PUID=1000
PGID=1001

# Postgres 配置
PGSQL_DBNAME=ms
PGSQL_USER=postgres
PGSQL_PASSWORD=YourPostgresPassword
PGSQL_PORT=15432

# Redis 配置
REDIS_PASSWORD=YourRedisPassword
REDIS_PORT=16379

# MSGO 配置
AUTH_EMAIL=username@sample.com
AUTH_SLOGAN=你的密钥
MS_PORT=8888

# QB 配置
QB_PORT=18989
QB_TORRENT_PORT=58365

# TR 配置
TR_PORT=9091

# Emby 配置
EMBY_PORT=18096
```


## docker-compose

服务说明：
1. `docker-compose.yml` 配置文件同目录下创建一个 `.env` 文件，里面保存密码
2. 容器中 `/etc/hosts` 映射出来，方便使用 MS 里面的 `hosts` 文件修改以及自动更新功能(既可以新建一个 `hosts` 文件，也可以直接使用 NAS 系统的 `hosts` 文件)
3. MS 使用 `privileged` 模式，方便 `MS` 直接控制 `Docker` 容器
4. `/BT_backup` 映射出来，方便 `MS` 访问 `qbittorrent` 的种子文件（转移种子）
5. `PUID=1000 PGID=1001 UMASK=022 TZ=Asia/Shanghai` 为固定配置，根据自己的情况修改（也可以改成 `0,0,000` 即 `root`）
6. 上面一条补充，无论如何改，所有 docker 容器的 PUID 和 PGID **都要一致**，否则会出现权限问题
7. 因为这里只配置到 `/media`, 所以 `QB`/`TR`/`MP` 实际下载目录就是： `/media/raw/movie`, `/media/raw/tv`, ...
8. 因为这里只配置到 `/media`, 所以 `MSGO`     实际整理目录就是： `/media/arc/movie`, `/media/arc/tv`, ...
9. `redis`、`pgsql` 因为暴露出端口给局域网了，所以**必须使用密码**，否则会被攻击



### `docker-compose.yml` 配置
```yaml
services:
  # redis 缓存数据，加速运行，必选
  redis:
    image: redis:latest
    container_name: msgo-redis
    restart: always
    command: /bin/sh -c "redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}" # 密码
    network_mode: bridge
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - ${DOCKER_PATH}/msgo/redis/data:/data
    environment:
      - TZ=Asia/Shanghai
      - GOSU_VERSION=1.17

  # pgsql 主数据库，必选
  pgsql:
    image: postgres:17-alpine  # 18版本会有大升级，可以锁死 17 版本
    container_name: msgo-pgsql
    restart: always
    network_mode: bridge
    ports:
      - "${PGSQL_PORT}:5432" # 对外访问端口
    volumes:
      - ${DOCKER_PATH}/msgo/pgsql/data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${PGSQL_DBNAME} # 数据库
      - POSTGRESQL_WAL_COMPRESSION=lz4 # 压缩算法
      - POSTGRESQL_MAX_CONNECTIONS=2048 # 最大连接数
      - POSTGRES_USER=${PGSQL_USER} # 用户
      - POSTGRES_PASSWORD=${PGSQL_PASSWORD} # 密码

  # msgo
  server:
    image: xylplm/media-saber:dev  # dev 比 latest 更适合
    container_name: msgo-server
    restart: always
    privileged: true
    network_mode: host  # 使用 host 模式，可以使用 ipv6
    #ports:
    #- "8899:8899"
    #- "8091:8091" # 使用 strm302 功能后，emby/jellyfin 代理端口
    volumes:
      - ${DOCKER_PATH}/msgo/common/hosts:/etc/hosts:rw
      - ${DOCKER_PATH}/msgo/ms/config:/app/config
      - ${DOCKER_PATH}/msgo/qb/config/qBittorrent/BT_backup:/BT_backup # 挂载 qb 目录，转种要用到
      - ${MEDIA_PATH}:/media
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=Asia/Shanghai
      - MS_PORT=${MS_PORT} # 前端端口
      - MS_AUTH_EMAIL=${AUTH_EMAIL} # 邮箱
      - MS_AUTH_SLOGAN=${AUTH_SLOGAN} # 授权码
      - MS_LOG_LEVEL=debug # 日志级别
      - MS_LOG_KEEP_DAYS=14 # 日志保留天数，只有在文件模式才会生效
      - MS_REDIS_HOST=${LOCAL_IP}:${REDIS_PORT} # redis 所属主机的局域网 ip:端口
      - MS_REDIS_PASS=${REDIS_PASSWORD} # redis 密码
      - MS_TIMEOUT=60000 # 接口请求超时，单位毫秒
      - MS_PGSQL_DBNAME=${PGSQL_DBNAME} # pgsql 数据库
      - MS_PGSQL_USERNAME=${PGSQL_USER} #  pgsql 用户
      - MS_PGSQL_PASSWORD=${PGSQL_PASSWORD} # pgsql 密码
      - MS_PGSQL_PATH=${LOCAL_IP} # pgsql 所属主机的局域网 ip
      - MS_PGSQL_PORT=${PGSQL_PORT} # pgsql 端口
      - MS_PGSQL_LOG_MODE=prod # 数据库日志 options=dev|test|prod|silent
      - MS_MQ_CONCURRENCY=10 # MQ 最大并发数

  # qb 下载
  qb:
    image: lscr.io/linuxserver/qbittorrent:14.3.9
    container_name: msgo-qb
    restart: always
    network_mode: host  # 使用 host 模式，可以使用 ipv6
    ports:
      - "${QB_PORT}:${QB_PORT}"  # 映射后，方便飞牛 docker 外网面访问
    volumes:
      - ${DOCKER_PATH}/msgo/common/hosts:/etc/hosts:ro
      - ${DOCKER_PATH}/msgo/qb/config:/config
      - ${MEDIA_PATH}:/media
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=Asia/Shanghai
      - WEBUI_PORT=${QB_PORT}
      - TORRENTING_PORT=${QB_TORRENT_PORT}

  # tr 保种
  tr:
    image: linuxserver/transmission:4.0.5
    container_name: msgo-tr
    restart: always
    network_mode: host  # 使用 host 模式，可以使用 ipv6
    ports:
      - "${TR_PORT}:${TR_PORT}"  # 映射后，方便飞牛 docker 外网面访问
    volumes:
      - ${DOCKER_PATH}/msgo/common/hosts:/etc/hosts:ro
      - ${DOCKER_PATH}/msgo/tr/config:/config
      - ${DOCKER_PATH}/msgo/tr/watch:/watch
      - ${MEDIA_PATH}:/media
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=Asia/Shanghai
      - PRCPROT=${TR_PORT}
      - TRANSMISSION_WEB_HOME=/config/theme/flood-for-transmission # 这是为了使用 flood 主题，不改可以注释

  # emby 媒体服务器
  emby:
    image: amilys/embyserver:4.8.11.0  # 4.9 修改了数据库结构，4.8不兼容
    container_name: msgo-emby
    restart: always
    privileged: true
    network_mode: bridge # DLNA and Wake-on-Lan 需要 bridge
    ports:
      - "${EMBY_PORT}:8096" # 对外访问端口
    volumes:
      - ${DOCKER_PATH}/msgo/emby/config:/config
      - ${DOCKER_PATH}/msgo/emby/strm:/strm # strm 目录，emby 添加这个目录到媒体库
      - ${MEDIA_PATH}:/media
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=Asia/Shanghai # 设置容器的时区为亚洲/上海
      - ALL_PROXY=http://${PROXY_PORT}:${PROXY_PORT}
      - HTTP_PROXY=http://${PROXY_PORT}:${PROXY_PORT}
      - NO_PROXY=172.17.0.1,127.0.0.1,localhost
    devices:
      - /dev/dri:/dev/dri # 将主机的 /dev/dri 设备挂载到容器 开启硬解

```


## 相关命令

### 当前用户添加到 docker 组
> 这样输 docker 命令时就不需要每次都 sudo 了
> 退出当前会话，重新登录即可生效

```bash
sudo usermod -aG docker $USER
```


### 启动
> 在 msgo 目录下执行
```bash
docker compose up -d
```

### 停止
> 在 msgo 目录下执行
```bash
docker compose down
```

### 查看 日志
> 在 msgo 目录下执行
```bash
docker compose logs server;
```

### 查看最后 10 条日志，并持续输出
> 在 msgo 目录下执行
> 这里的 `server` 是 yaml 里面配置的名字，根据实际情况修改, 如 `emby`
```bash
docker compose logs server -f --tail 10;
```
